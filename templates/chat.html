{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="navbar">
            <h1><i class="fas fa-comments"></i> Chat App</h1>
            <div class="nav-links">
                <span>Welcome, {{ current_user }}!</span>
                <a href="{{ url_for('profile') }}"><i class="fas fa-user"></i> Profile</a>
                <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="sidebar">
                <div class="search-container">
                    <input type="text" id="searchUsers" placeholder="Search users..." class="search-input">
                    <i class="fas fa-search search-icon"></i>
                </div>
                
                <div class="users-list" id="usersList">
                    <!-- Users will be loaded here -->
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-header" id="chatHeader" style="display: none;">
                    <div class="user-info">
                        <button class="btn-icon back-btn" id="backToUsersList" title="Back to users">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <img src="" alt="" class="user-avatar" id="chatUserAvatar" style="cursor: pointer;">
                        <div>
                            <div class="user-name" id="chatUserName"></div>
                            <div class="user-status" id="chatUserStatus"></div>
                            <div class="typing-indicator" id="typingIndicator" style="display: none;">typing...</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="btn-icon" id="voiceCallBtn" onclick="initiateVoiceCall()" title="Voice Call" style="display: none;"> <!-- Initially hidden -->
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn-icon" onclick="clearChat()" title="Clear Chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- Hidden audio elements for WebRTC -->
                <audio id="localAudio" autoplay muted playsinline style="display:none;"></audio>
                <audio id="remoteAudio" autoplay playsinline style="display:none;"></audio>
                <audio id="ringtoneAudio" loop style="display:none;"></audio>

                <!-- Incoming Call Modal -->
                <div id="incomingCallModal" class="call-modal" style="display: none;">
                    <div class="call-modal-content">
                        <h4>Incoming Call</h4>
                        <p><span id="callerName"></span> is calling...</p>
                        <div class="call-modal-actions">
                            <button id="acceptCallBtn" class="btn-call-action accept"><i class="fas fa-phone"></i> Accept</button>
                            <button id="rejectCallBtn" class="btn-call-action reject"><i class="fas fa-phone-slash"></i> Reject</button>
                        </div>
                    </div>
                </div>

                <!-- Active Call UI -->
                <div id="activeCallUI" class="active-call-ui" style="display: none;">
                    <p>Call with <span id="activeCallPartnerName"></span></p>
                    <div id="callStatus">Connecting...</div>
                    <div class="call-controls">
                        <button id="muteCallBtn" class="btn-call-control"><i class="fas fa-microphone"></i> Mute</button>
                        <button id="endCallBtn" class="btn-call-control end"><i class="fas fa-phone-slash"></i> End Call</button>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="welcome-message">
                        <i class="fas fa-comments"></i>
                        <h3>Welcome to Chat App!</h3>
                        <p>Select a user from the sidebar to start chatting</p>
                    </div>
                </div>
                
                <div class="message-input-container" id="messageInputContainer" style="display: none;">
                    <div id="replyPreviewContainer" class="reply-preview-container" style="display: none;">
                        <div class="reply-preview-content">
                            <div class="reply-preview-header">Replying to <strong id="replyPreviewSender"></strong></div>
                            <div id="replyPreviewText"></div>
                        </div>
                        <button class="cancel-reply-btn" onclick="cancelReply()" title="Cancel reply">&times;</button>
                    </div>
                    <div class="message-input-row">
                        <button class="emoji-btn" onclick="toggleEmojiPicker()" title="Emoji">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="attach-btn" id="attachFileBtn" title="Attach file">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="file" id="mediaFile" style="display:none;" accept="image/*,.heic,.heif,audio/*,video/*,.pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx,.zip,.rar">
                        <input type="text" id="messageInput" placeholder="Type a message..." maxlength="1000">
                        <button class="send-btn" onclick="sendMessage()" title="Send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="emoji-picker" id="emojiPicker">
    <div class="emoji" onclick="addEmoji('üòÄ')">üòÄ</div>
    <div class="emoji" onclick="addEmoji('üòÇ')">üòÇ</div>
    <div class="emoji" onclick="addEmoji('üòç')">üòç</div>
    <div class="emoji" onclick="addEmoji('ü•∞')">ü•∞</div>
    <div class="emoji" onclick="addEmoji('üòé')">üòé</div>
    <div class="emoji" onclick="addEmoji('ü§î')">ü§î</div>
    <div class="emoji" onclick="addEmoji('üò¢')">üò¢</div>
    <div class="emoji" onclick="addEmoji('üò≠')">üò≠</div>
    <div class="emoji" onclick="addEmoji('üò°')">üò°</div>
    <div class="emoji" onclick="addEmoji('üëç')">üëç</div>
    <div class="emoji" onclick="addEmoji('üëé')">üëé</div>
    <div class="emoji" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
    <div class="emoji" onclick="addEmoji('üî•')">üî•</div>
    <div class="emoji" onclick="addEmoji('‚ú®')">‚ú®</div>
    <div class="emoji" onclick="addEmoji('üéâ')">üéâ</div>
</div>

<!-- Image Preview Modal -->
<div id="imagePreviewModal" class="image-preview-modal" style="display: none;">
    <span class="close-preview-btn" onclick="closeImagePreview()">&times;</span>
    <img class="image-preview-content" id="previewImage">
    <div id="imagePreviewCaption" class="image-preview-caption"></div>
</div>

<!-- User Profile Detail Modal -->
<div id="userProfileDetailModal" class="profile-detail-modal" style="display: none;">
    <div class="profile-detail-modal-content">
        <span class="close-profile-detail-btn" onclick="closeUserProfileDetailModal()">&times;</span>
        <div class="profile-detail-header">
            <img src="/static/default_avatar_new.png" alt="User Avatar" id="modalUserProfileAvatar" class="profile-detail-avatar">
        </div>
        <div class="profile-detail-body">
            <h3 id="modalUserProfileName">User Name</h3>
            <p id="modalUserProfileUsername">@username</p>
            <p id="modalUserProfileBio">Bio will appear here.</p>
            <p>Status: <span id="modalUserProfileStatus">Offline</span></p>
            <p>Last Seen: <span id="modalUserProfileLastSeen">N/A</span></p>
            <!-- Add more fields as needed -->
        </div>
    </div>
</div>


<style>
/* Mobile-specific overrides for base.html elements to allow full-screen chat */
@media (max-width: 767px) {
    html, body {
        height: 100%;
        overflow: hidden !important;
    }

    body > .container { 
        padding: 0 !important;
        margin: 0 !important; 
        max-width: none !important;
        height: 100vh !important;
        display: flex;
    }

    body > .container > .card {
        border-radius: 0 !important;
        box-shadow: none !important;
        margin: 0 !important;
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
    }

    /* Fix navbar for mobile */
    .navbar {
        padding: 10px 15px !important;
        min-height: 60px;
        flex-shrink: 0;
    }

    .navbar h1 {
        font-size: 1.2rem !important;
    }

    .nav-links {
        font-size: 0.9rem;
    }

    /* Mobile chat container */
    .chat-container {
        display: flex;
        width: 100%;
        flex: 1;
        overflow: hidden;
        position: relative;
    }

    .sidebar {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        background: white;
        transition: transform 0.3s ease;
        border-right: none;
    }

    .chat-area {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 100%; /* Start off-screen */
        z-index: 20;
        background: white;
        transition: transform 0.3s ease;
        display: flex !important;
        flex-direction: column;
    }

    .chat-container.chat-active .sidebar {
        transform: translateX(-100%);
    }

    .chat-container.chat-active .chat-area {
        transform: translateX(-100%);
    }

    /* Adjust search bar for mobile */
    .search-container {
        padding: 12px 15px;
    }

    .search-input {
        padding: 10px 35px 10px 12px;
        font-size: 16px; /* Prevents zoom on iOS */
    }

    .search-icon {
        right: 25px;
    }

    /* Adjust user items for mobile */
    .user-item {
        padding: 12px 15px;
    }

    .user-avatar {
        width: 45px;
        height: 45px;
    }

    /* Chat header adjustments */
    .chat-header {
        padding: 10px 15px;
        min-height: 60px;
        flex-shrink: 0;
    }

    .back-btn {
        display: flex !important;
        margin-right: 8px;
        font-size: 1.2rem;
    }

    .chat-header .user-avatar {
        width: 35px;
        height: 35px;
    }

    /* Messages container */
    .messages-container {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        min-height: 0;
    }

    .message-bubble {
        max-width: 85%;
        padding: 10px 14px;
    }

    /* Message input container */
    .message-input-container {
        padding: 8px 12px;
        flex-shrink: 0;
        background: white;
        border-top: 1px solid #e0e0e0;
    }

    .message-input-row {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #messageInput {
        padding: 12px 15px;
        font-size: 16px; /* Prevents zoom on iOS */
        flex: 1;
    }

    .emoji-btn, .attach-btn, .send-btn {
        padding: 10px;
        min-width: 44px; /* Minimum touch target size */
        min-height: 44px;
    }

    .send-btn {
        padding: 12px 14px;
    }

    /* Adjust emoji picker for mobile */
    .emoji-picker {
        position: fixed;
        bottom: 70px;
        left: 0;
        width: 100%;
        background: white;
        border-top: 1px solid #e0e0e0;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        z-index: 30;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .emoji {
        font-size: 1.5rem;
        padding: 8px;
        min-width: 44px;
        text-align: center;
    }

    /* Call UI adjustments for mobile */
    .call-modal {
        z-index: 1000;
    }

    .call-modal-content {
        width: 90%;
        max-width: 300px;
        margin: 0 20px;
    }

    .active-call-ui {
        width: 90%;
        max-width: 300px;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
    }

    /* Image preview modal for mobile */
    .image-preview-modal {
        padding-top: 20px;
    }

    .image-preview-content {
        max-width: 95%;
        max-height: 80vh;
    }

    .close-preview-btn {
        top: 10px;
        right: 15px;
        font-size: 35px;
    }

    /* Profile detail modal for mobile */
    .profile-detail-modal-content {
        width: 95%;
        max-width: 95%;
        margin: 10px;
        max-height: 90vh;
        overflow-y: auto;
    }

    /* Hide scrollbars but keep functionality */
    .users-list::-webkit-scrollbar,
    .messages-container::-webkit-scrollbar {
        width: 4px;
    }

    .users-list::-webkit-scrollbar-track,
    .messages-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .users-list::-webkit-scrollbar-thumb,
    .messages-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 2px;
    }

    /* Improve touch targets */
    .message-action-btn {
        padding: 8px;
        min-width: 36px;
        min-height: 36px;
    }

    /* Adjust audio player for mobile */
    .custom-audio-player {
        min-width: 180px;
    }

    .audio-play-pause-btn {
        width: 40px;
        height: 40px;
    }

    /* File upload progress */
    .upload-progress-filename {
        word-break: break-all;
        font-size: 0.85em;
    }

    /* Typing indicator */
    .typing-indicator {
        font-size: 0.8em;
        color: #128C7E;
    }

    /* Welcome message for mobile */
    .welcome-message {
        padding: 20px;
        text-align: center;
        margin-top: 50px;
    }

    .welcome-message i {
        font-size: 3rem;
        margin-bottom: 15px;
    }

    .welcome-message h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .welcome-message p {
        font-size: 1rem;
        color: #666;
    }
}

/* iPhone notch and safe area support */
@supports (padding: max(0px)) {
    @media (max-width: 767px) {
        body > .container {
            padding-top: env(safe-area-inset-top) !important;
            padding-bottom: env(safe-area-inset-bottom) !important;
            padding-left: env(safe-area-inset-left) !important;
            padding-right: env(safe-area-inset-right) !important;
        }
        
        .navbar {
            padding-top: calc(10px + env(safe-area-inset-top)) !important;
        }
        
        .message-input-container {
            padding-bottom: calc(8px + env(safe-area-inset-bottom)) !important;
        }
    }
}

/* Tablet responsive adjustments */
@media (min-width: 768px) and (max-width: 1024px) {
    .sidebar {
        width: 250px !important;
    }
    
    .message-bubble {
        max-width: 80%;
    }
    
    .navbar {
        padding: 12px 20px !important;
    }
}

/* Desktop (unchanged from original but included for clarity) */
@media (min-width: 768px) {
    .chat-container {
        flex-direction: row !important;
        height: 600px;
    }

    .sidebar {
        width: 300px !important;
        height: 100% !important;
        display: flex !important;
        border-right: 1px solid #e0e0e0 !important;
        position: relative !important;
    }

    .chat-area {
        flex: 1 !important;
        width: auto !important;
        height: 100% !important;
        display: flex !important;
        position: relative !important;
        left: 0 !important;
        transform: none !important;
    }

    .back-btn {
        display: none !important;
    }

    .emoji-picker {
        position: absolute;
        bottom: 60px;
        left: 20px;
        width: 250px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .chat-container.chat-active .sidebar {
        transform: none !important;
        display: flex !important;
    }
}

/* Additional mobile optimizations */
.message {
    margin-bottom: 8px;
}

.message-time {
    font-size: 10px;
}

.message-actions {
    opacity: 1 !important; /* Always show on mobile for easier access */
}

/* Prevent text selection on interactive elements */
.user-item,
.message-action-btn,
.btn-icon,
.emoji,
.send-btn,
.attach-btn,
.emoji-btn {
    user-select: none;
    -webkit-user-select: none;
}

/* Improve tap highlights */
a, button, .user-item, .message-bubble img {
    -webkit-tap-highlight-color: rgba(0,0,0,0.1);
}

/* Optimize for mobile performance */
.message-bubble img,
.message-bubble video {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
}

/* Adjust reply preview for mobile */
.reply-preview-container {
    font-size: 0.85em;
    padding: 6px 10px;
}

.reply-preview-header {
    font-size: 0.8em;
}

/* Status indicators */
.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
}

.status-online {
    background-color: #4CAF50;
}

.status-offline {
    background-color: #9E9E9E;
}

/* Unread badge */
.unread-count-badge {
    font-size: 0.7em;
    padding: 3px 8px;
}

/* Loading state */
.loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
    color: #666;
}

.loading-spinner.active {
    display: block;
}

/* Connection status */
.connection-status {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #f44336;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.8em;
    z-index: 1000;
    display: none;
}

.connection-status.connected {
    background: #4CAF50;
}
</style>

<script>
// Mobile-specific JavaScript improvements
document.addEventListener('DOMContentLoaded', function() {
    // Load users
    loadUsers();
    
    // Initialize mobile view
    initMobileView();
    
    // Search functionality with debounce
    const searchInput = document.getElementById('searchUsers');
    let searchTimeout;
    searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = e.target.value;
            if (query.length > 0) {
                searchUsers(query);
            } else {
                loadUsers();
            }
        }, 300);
    });
    
    // Enter key to send message
    const messageInput = document.getElementById('messageInput');
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Typing indicator with debounce
    let typingTimeout = null;
    const TYPING_TIMER_LENGTH = 1500;
    
    messageInput.addEventListener('input', () => {
        if (!currentChatUser) return;
        
        socket.emit('typing_start', { receiver: currentChatUser, sender: currentUser });
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit('typing_stop', { receiver: currentChatUser, sender: currentUser });
        }, TYPING_TIMER_LENGTH);
    });
    
    // Handle file upload
    document.getElementById('attachFileBtn').addEventListener('click', () => {
        document.getElementById('mediaFile').click();
    });
    
    // Handle file selection
    document.getElementById('mediaFile').addEventListener('change', handleFileUpload);
    
    // Prevent scrolling when modal is open
    setupModalScrollPrevention();
    
    // Handle back button for mobile
    setupMobileBackButton();
    
    // Handle swipe gestures for mobile
    setupSwipeGestures();
    
    // Handle keyboard show/hide on mobile
    setupKeyboardHandling();
    
    // Handle orientation change
    window.addEventListener('orientationchange', handleOrientationChange);
    
    // Handle app install prompt
    setupAppInstallPrompt();
});

// Initialize mobile view
function initMobileView() {
    // Check if mobile device
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // Add mobile class to body
        document.body.classList.add('mobile-device');
        
        // Disable double tap zoom
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });
        
        // Prevent pull-to-refresh on messages container
        const messagesContainer = document.getElementById('messagesContainer');
        let startY = 0;
        
        messagesContainer.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        }, { passive: true });
        
        messagesContainer.addEventListener('touchmove', function(e) {
            const currentY = e.touches[0].clientY;
            
            // If user is scrolling up or if we're not at the top, allow scroll
            if (messagesContainer.scrollTop > 0 || currentY > startY) {
                return;
            }
            
            // Prevent pull-to-refresh when at top and pulling down
            if (messagesContainer.scrollTop === 0 && currentY < startY) {
                e.preventDefault();
            }
        }, { passive: false });
    }
}

// Setup mobile back button
function setupMobileBackButton() {
    const backButton = document.getElementById('backToUsersList');
    if (backButton) {
        backButton.addEventListener('click', function() {
            closeChat();
        });
    }
    
    // Also handle Android back button
    if (window.history && window.history.pushState) {
        window.addEventListener('popstate', function() {
            if (currentChatUser) {
                closeChat();
            }
        });
    }
}

// Close chat and go back to users list
function closeChat() {
    document.querySelector('.chat-container').classList.remove('chat-active');
    currentChatUser = null;
    document.getElementById('chatHeader').style.display = 'none';
    document.getElementById('messageInputContainer').style.display = 'none';
    document.getElementById('messagesContainer').innerHTML = `
        <div class="welcome-message">
            <i class="fas fa-comments"></i>
            <h3>Welcome to Chat App!</h3>
            <p>Select a user from the sidebar to start chatting</p>
        </div>`;
    
    // Update browser history
    if (window.history && window.history.pushState) {
        history.pushState(null, null, window.location.pathname);
    }
}

// Setup swipe gestures for mobile
function setupSwipeGestures() {
    let startX = 0;
    let startY = 0;
    let isSwiping = false;
    
    document.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isSwiping = true;
    }, { passive: true });
    
    document.addEventListener('touchmove', function(e) {
        if (!isSwiping) return;
        
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = currentX - startX;
        const diffY = currentY - startY;
        
        // If horizontal swipe is more significant than vertical
        if (Math.abs(diffX) > Math.abs(diffY)) {
            e.preventDefault();
        }
    }, { passive: false });
    
    document.addEventListener('touchend', function(e) {
        if (!isSwiping) return;
        
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        const diffX = endX - startX;
        const diffY = endY - startY;
        
        // Check if it's a significant horizontal swipe
        if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
            // Left swipe (from right to left)
            if (diffX < -50 && !currentChatUser) {
                // Could implement opening chat from users list
            }
            // Right swipe (from left to right)
            else if (diffX > 50 && currentChatUser) {
                closeChat();
            }
        }
        
        isSwiping = false;
    }, { passive: true });
}

// Handle keyboard show/hide on mobile
function setupKeyboardHandling() {
    const messageInput = document.getElementById('messageInput');
    const messagesContainer = document.getElementById('messagesContainer');
    
    messageInput.addEventListener('focus', function() {
        // Scroll to bottom when keyboard appears
        setTimeout(() => {
            scrollToBottom();
        }, 300);
    });
    
    // Adjust layout when keyboard appears/disappears
    window.addEventListener('resize', function() {
        setTimeout(() => {
            if (document.activeElement === messageInput) {
                scrollToBottom();
            }
        }, 300);
    });
}

// Handle orientation change
function handleOrientationChange() {
    // Wait for orientation change to complete
    setTimeout(() => {
        scrollToBottom();
        // Recalculate any dynamic heights if needed
        adjustLayoutForOrientation();
    }, 300);
}

// Adjust layout for orientation
function adjustLayoutForOrientation() {
    const isPortrait = window.innerHeight > window.innerWidth;
    
    if (isPortrait) {
        // Portrait adjustments
        document.body.style.height = window.innerHeight + 'px';
    } else {
        // Landscape adjustments
        document.body.style.height = '100%';
    }
}

// Setup app install prompt
function setupAppInstallPrompt() {
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent Chrome 67 and earlier from automatically showing the prompt
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        
        // Show install button (you can add this to your UI)
        showInstallPrompt();
    });
    
    window.addEventListener('appinstalled', () => {
        // Hide install button
        hideInstallPrompt();
        // Clear the deferredPrompt
        deferredPrompt = null;
    });
}

function showInstallPrompt() {
    // Add install button to your UI
    const installButton = document.createElement('button');
    installButton.id = 'installButton';
    installButton.innerHTML = '<i class="fas fa-download"></i> Install App';
    installButton.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #128C7E;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        font-size: 14px;
    `;
    
    installButton.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        // Show the install prompt
        deferredPrompt.prompt();
        
        // Wait for the user to respond to the prompt
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            console.log('User accepted the install prompt');
        } else {
            console.log('User dismissed the install prompt');
        }
        
        // Clear the deferredPrompt
        deferredPrompt = null;
        
        // Hide the install button
        installButton.remove();
    });
    
    document.body.appendChild(installButton);
}

function hideInstallPrompt() {
    const installButton = document.getElementById('installButton');
    if (installButton) {
        installButton.remove();
    }
}

// Setup modal scroll prevention
function setupModalScrollPrevention() {
    const modals = ['imagePreviewModal', 'userProfileDetailModal', 'incomingCallModal'];
    
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('touchmove', function(e) {
                if (modal.style.display === 'flex' || modal.style.display === 'block') {
                    e.preventDefault();
                }
            }, { passive: false });
        }
    });
}

// Select user to chat with (mobile optimized)
function selectUser(username) {
    if (isCallActive && username !== callTargetUser) {
        alert("Please end the current call before switching to another chat.");
        return;
    }
    
    currentChatUser = username;
    
    // Add to browser history for back button support
    if (window.history && window.history.pushState) {
        history.pushState({ chatWith: username }, null, `?chat=${username}`);
    }
    
    document.querySelector('.chat-container').classList.add('chat-active');
    
    document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const clickedItem = Array.from(document.querySelectorAll('.user-item')).find(item => {
        const userName = item.querySelector('.user-name');
        return userName && userName.textContent.trim() === username;
    });
    
    if (clickedItem) {
        clickedItem.classList.add('active');
    }
    
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('messageInputContainer').style.display = 'flex';
    
    // Load user details with loading state
    showLoadingState();
    
    fetch('/api/users')
        .then(response => response.json())
        .then(users => {
            const user = users.find(u => u.username === username);
            if (user) {
                document.getElementById('chatUserAvatar').src = user.profile_photo || '/static/default_avatar_new.png';
                document.getElementById('chatUserName').textContent = user.name;
                const statusClass = user.status === 'online' ? 'status-online' : 'status-offline';
                const lastSeen = user.status === 'online' ? 'Online' : formatLastSeen(user.last_seen);
                document.getElementById('chatUserStatus').innerHTML = `
                    <span class="status-indicator ${statusClass}"></span>
                    ${lastSeen}
                `;
                document.getElementById('voiceCallBtn').style.display = 'inline-flex';
                document.getElementById('typingIndicator').style.display = 'none';
            }
            hideLoadingState();
        })
        .catch(error => {
            console.error('Error loading user details:', error);
            hideLoadingState();
        });
    
    loadMessages(username);
}

// Show loading state
function showLoadingState() {
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.innerHTML = `
        <div class="loading-spinner active">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Loading messages...</p>
        </div>
    `;
}

// Hide loading state
function hideLoadingState() {
    const loadingSpinner = document.querySelector('.loading-spinner');
    if (loadingSpinner) {
        loadingSpinner.classList.remove('active');
    }
}

// Improved scroll to bottom for mobile
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // Use smooth scrolling if supported
    container.scrollTo({
        top: container.scrollHeight,
        behavior: 'smooth'
    });
}

// Handle file upload with better mobile support
function handleFileUpload(event) {
    const file = event.target.files[0];
    const fileInput = event.target;
    
    if (!file || !currentChatUser) {
        if (!currentChatUser) {
            showToast('Please select a chat to send the file.');
        }
        fileInput.value = null;
        return;
    }
    
    // Check file size (max 10MB for mobile)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        showToast('File size too large. Maximum size is 10MB.');
        fileInput.value = null;
        return;
    }
    
    const clientUploadId = `upload-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;
    
    // Create and display placeholder message with progress bar
    addUploadPlaceholder(clientUploadId, file.name);
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Show network activity indicator on mobile
    if (navigator.connection) {
        const connection = navigator.connection;
        if (connection.saveData || connection.effectiveType === 'slow-2g') {
            showToast('Slow network detected. Upload may take longer.');
        }
    }
    
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/upload_chat_media', true);
    
    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            updateUploadProgress(clientUploadId, percentComplete);
        }
    };
    
    xhr.onload = function() {
        const placeholderElement = document.getElementById(clientUploadId);
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success) {
                    sendMediaMessage(data.file_url, data.file_type, data.original_filename, clientUploadId);
                } else {
                    if (placeholderElement) {
                        updateUploadPlaceholderWithError(clientUploadId, `Upload failed: ${data.error}`);
                    } else {
                        showToast(`Upload failed: ${data.error}`);
                    }
                }
            } catch (jsonError) {
                if (placeholderElement) {
                    updateUploadPlaceholderWithError(clientUploadId, 'Upload failed: Invalid server response.');
                }
            }
        } else {
            let errorMsg = `Upload failed. Server responded with status: ${xhr.status}`;
            try {
                const data = JSON.parse(xhr.responseText);
                if (data && data.error) {
                    errorMsg = `Upload failed: ${data.error}`;
                }
            } catch (e) { /* ignore if not JSON */ }
            
            if (placeholderElement) {
                updateUploadPlaceholderWithError(clientUploadId, errorMsg);
            } else {
                showToast(errorMsg);
            }
        }
        fileInput.value = null;
    };
    
    xhr.onerror = function() {
        const placeholderElement = document.getElementById(clientUploadId);
        if (placeholderElement) {
            updateUploadPlaceholderWithError(clientUploadId, 'Upload failed: Network error.');
        } else {
            showToast('Upload failed: Network error. Please try again.');
        }
        fileInput.value = null;
    };
    
    xhr.onabort = function() {
        const placeholderElement = document.getElementById(clientUploadId);
        if (placeholderElement) {
            placeholderElement.remove();
        }
        fileInput.value = null;
    };
    
    xhr.send(formData);
}

// Show toast notification for mobile
function showToast(message, duration = 3000) {
    // Remove existing toast
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        z-index: 10000;
        font-size: 14px;
        max-width: 80%;
        text-align: center;
        animation: fadeInOut ${duration}ms ease-in-out;
    `;
    
    document.body.appendChild(toast);
    
    // Add CSS for animation
    if (!document.querySelector('#toast-animation')) {
        const style = document.createElement('style');
        style.id = 'toast-animation';
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
                10% { opacity: 1; transform: translateX(-50%) translateY(0); }
                90% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, duration);
}

// Connection status monitoring for mobile
function setupConnectionMonitoring() {
    const connectionStatus = document.createElement('div');
    connectionStatus.className = 'connection-status';
    connectionStatus.textContent = 'Connecting...';
    document.body.appendChild(connectionStatus);
    
    function updateConnectionStatus() {
        if (navigator.onLine) {
            connectionStatus.textContent = 'Online';
            connectionStatus.classList.remove('disconnected');
            connectionStatus.classList.add('connected');
            connectionStatus.style.display = 'block';
            
            // Hide after 2 seconds
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 2000);
        } else {
            connectionStatus.textContent = 'Offline - Reconnecting...';
            connectionStatus.classList.remove('connected');
            connectionStatus.classList.add('disconnected');
            connectionStatus.style.display = 'block';
        }
    }
    
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    
    // Initial check
    updateConnectionStatus();
}

// Add this to your existing socket connection code
socket.on('connect', () => {
    showToast('Connected to server', 2000);
});

socket.on('disconnect', () => {
    showToast('Disconnected from server', 3000);
});

socket.on('reconnect', () => {
    showToast('Reconnected to server', 2000);
    // Reload users and messages if needed
    if (currentChatUser) {
        loadUsers();
        loadMessages(currentChatUser);
    }
});

// Prevent form submission on enter in search
document.getElementById('searchUsers').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
    }
});

// Handle image preview for mobile
function openImagePreview(imageUrl, captionText) {
    const modal = document.getElementById('imagePreviewModal');
    const modalImg = document.getElementById('previewImage');
    const caption = document.getElementById('imagePreviewCaption');
    
    modal.style.display = "block";
    modalImg.src = imageUrl;
    caption.textContent = captionText || '';
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

function closeImagePreview() {
    const modal = document.getElementById('imagePreviewModal');
    modal.style.display = "none";
    document.getElementById('previewImage').src = "";
    document.getElementById('imagePreviewCaption').textContent = "";
    
    // Restore body scroll
    document.body.style.overflow = 'auto';
}

// Handle profile detail modal for mobile
function openUserProfileDetailModal(username) {
    const modal = document.getElementById('userProfileDetailModal');
    modal.style.display = 'flex';
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
    
    // Rest of your existing code...
}

function closeUserProfileDetailModal() {
    const modal = document.getElementById('userProfileDetailModal');
    modal.style.display = 'none';
    
    // Restore body scroll
    document.body.style.overflow = 'auto';
}

// Optimize for mobile performance
window.addEventListener('load', function() {
    // Lazy load images
    const images = document.querySelectorAll('img[data-src]');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                observer.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
    
    // Service Worker registration for PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('ServiceWorker registration successful');
            })
            .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
    }
});
</script>

{% endblock %}
